import { useEffect, useState } from "react";

export default function SimpleProfileApp() {
  const [name, setName] = useState("");
  const [bio, setBio] = useState("");
  const [insta, setInsta] = useState("");
  const [image, setImage] = useState<string | null>(null);
  const [viewMode, setViewMode] = useState(false);

  useEffect(() => {
    const saved = localStorage.getItem("profile");
    if (saved) {
      const data = JSON.parse(saved);
      setName(data.name || "");
      setBio(data.bio || "");
      setInsta(data.insta || "");
      setImage(data.image || null);
      setViewMode(true);
    }
  }, []);

  const onImageChange = (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => setImage(reader.result as string);
    reader.readAsDataURL(file);
  };

  const saveProfile = () => {
    (document.activeElement as HTMLElement | null)?.blur();

    if (!name) {
      alert("名前を入力してね");
      return;
    }
    const cleanInsta = insta.startsWith("@") ? insta.slice(1) : insta;
    localStorage.setItem(
      "profile",
      JSON.stringify({ name, bio, insta: cleanInsta, image })
    );
    setViewMode(true);
  };

  return (
    <div style={styles.body}>
      {!viewMode ? (
        <div style={styles.card}>
          <label style={styles.iconWrapper}>
            {image ? (
              <img src={image} style={styles.iconImg} />
            ) : (
              <div style={styles.placeholder}>＋</div>
            )}
            <input
              type="file"
              accept="image/*"
              onChange={onImageChange}
              style={{ display: "none" }}
            />
          </label>

          <h1 style={styles.h1}>My Profile</h1>

          <input
            style={styles.input}
            placeholder="名前"
            value={name}
            onChange={(e) => setName(e.target.value)}
          />
          <textarea
            style={{ ...styles.input, height: 80 }}
            placeholder="自己紹介"
            value={bio}
            onChange={(e) => setBio(e.target.value)}
          />
          <input
            style={styles.input}
            placeholder="Instagram ID"
            value={insta}
            onChange={(e) => setInsta(e.target.value)}
          />

          <button style={styles.button} onClick={saveProfile}>
            ♡ カードをつくる ♡
          </button>
        </div>
      ) : (
        <div style={styles.card}>
          {image && (
            <div style={styles.iconWrapper}>
              <img src={image} style={styles.iconImg} />
            </div>
          )}
          <h1 style={styles.h1}>{name}</h1>
          <p>{bio}</p>
          {insta && (
            <a
              href={`https://www.instagram.com/${insta}`}
              target="_blank"
              rel="noreferrer"
              style={styles.insta}
            >
              @{insta}
            </a>
          )}
        </div>
      )}
    </div>
  );
}

const styles: any = {
  body: {
    minHeight: "100svh",
    display: "flex",
    justifyContent: "center",
    alignItems: "center",
    background: "linear-gradient(135deg, #ffd6e8, #e0f7ff)",
    fontFamily:
      '"Rounded Mplus 1c", system-ui, -apple-system, BlinkMacSystemFont, sans-serif',
    padding: "env(safe-area-inset-bottom) env(safe-area-inset-left)",
  },
  card: {
    background: "#fff",
    width: "100%",
    maxWidth: 360,
    margin: 12,
    borderRadius: 24,
    padding: 20,
    boxShadow: "0 10px 25px rgba(0,0,0,0.1)",
    textAlign: "center",
  },
  h1: { color: "#ff6fa9" },
  iconWrapper: {
    width: 120,
    height: 120,
    borderRadius: "50%",
    margin: "0 auto 8px",
    overflow: "hidden",
    cursor: "pointer",
    boxShadow: "0 4px 10px rgba(0,0,0,0.15)",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
  },
  iconImg: { width: "100%", height: "100%", objectFit: "cover" },
  placeholder: { fontSize: 40, color: "#bbb" },
  input: {
    width: "100%",
    padding: "10px 12px",
    margin: "8px 0",
    borderRadius: 12,
    border: "1px solid #ddd",
    fontSize: 16,
  },
  button: {
    width: "100%",
    marginTop: 16,
    padding: 16,
    fontSize: 16,
    border: "none",
    borderRadius: 999,
    background: "linear-gradient(135deg, #ff9acb, #ff6fa9)",
    color: "white",
    cursor: "pointer",
    minHeight: 48,
    touchAction: "manipulation",
  },
  insta: { color: "#ff6fa9", fontWeight: "bold" },
};
